<!doctype html>
<html>
<head>
  <title>Equinox Dashboard - {{username}}</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: #121212;
      color: #E0E0E0;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 25px;
    }

    header img {
      width: 55px;
      height: 55px;
    }

    header h1 {
      margin: 0;
      font-size: 26px;
      color: #40E0D0;
    }

    header p {
      margin: 0;
      font-size: 14px;
      color: #A0A0A0;
    }

    .aura-card {
      background: radial-gradient(circle at top left, #40e0d0, #1e1e1e);
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      margin-bottom: 25px;
      box-shadow: 0 0 15px rgba(64, 224, 208, 0.3);
    }

    .aura-card h2 {
      color: #40E0D0;
      margin-bottom: 10px;
    }

    .chart-grid {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 20px;
    }

    .chart-card {
      flex: 1 1 48%;
      background: #1E1E1E;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 0 10px rgba(64, 224, 208, 0.2);
      text-align: center;
      min-width: 400px;
    }

    canvas {
      width: 100% !important;
      height: 280px !important;
      background: #121212;
      border-radius: 8px;
      padding: 5px;
    }

    @media (max-width: 900px) {
      .chart-card {
        flex: 1 1 100%;
      }
      canvas {
        height: 260px !important;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <img src="{{ url_for('static', filename='logo.png') }}" alt="Equinox Logo">
      <div>
        <h1>Equinox</h1>
        <p>Balancing minds, one insight at a time.</p>
      </div>
    </header>

    <!-- ðŸŒˆ Aura -->
    <div class="aura-card">
      <h2>Your Aura</h2>
      <p id="aura-info">Loading...</p>
    </div>

    <!-- ðŸ“ˆ Charts Grid -->
    <div class="chart-grid">
      <!-- Mood Trend -->
      <div class="chart-card">
        <h3>Mood Trend (Last 60 Days)</h3>
        <canvas id="moodChart"></canvas>
      </div>

      <!-- Emotion Radar -->
      <div class="chart-card">
        <h3>Weekly Emotion Distribution</h3>
        <canvas id="emotionRadar"></canvas>
      </div>
    </div>
  </div>

  <script>
    const username = "{{username}}";

    // --- Fetch Aura ---
    fetch(`/api/aura/${username}`)
      .then(r => r.json())
      .then(data => {
        const auraDiv = document.getElementById("aura-info");
        if (!data || data.error) {
          auraDiv.textContent = "Not enough data to determine aura.";
        } else {
          auraDiv.innerHTML = `<strong>${data.aura}</strong><br>${data.description}`;
        }
      });

    // --- Fetch Mood Trend ---
    fetch(`/api/fetch/${username}`)
      .then(r => r.json())
      .then(fetchData => {
        if (fetchData.fetched > 0) {
          return fetch(`/api/mood_trend/${username}?days=60`);
        } else {
          throw new Error("No posts fetched for this user.");
        }
      })
      .then(r => r.json())
      .then(data => {
        const trend = data.trend || [];
        if (trend.length === 0) return;

        const labels = trend.map(d => d.date);
        const values = trend.map(d => d.avg_compound);

        new Chart(document.getElementById("moodChart"), {
          type: "line",
          data: {
            labels: labels,
            datasets: [{
              label: "Mood Sentiment (Daily Avg)",
              data: values,
              fill: true,
              borderColor: "#40E0D0",
              backgroundColor: "rgba(64,224,208,0.15)",
              tension: 0.25,
              pointRadius: 3,
              pointBackgroundColor: "#40E0D0"
            }]
          },
          options: {
            scales: {
              y: { min: -1, max: 1, ticks: { color: "#E0E0E0" } },
              x: { ticks: { color: "#E0E0E0" } }
            },
            plugins: { legend: { labels: { color: "#E0E0E0" } } },
            maintainAspectRatio: false
          }
        });
      });

// --- Fetch Weekly Emotion Distribution ---
fetch(`/api/emotions/${username}`)
  .then(r => r.json())
  .then(data => {
    if (!data || Object.keys(data).length === 0) return;

    const labels = Object.keys(data);
    const rawValues = Object.values(data);

    // ðŸ”¹ Scale emotion values for better visibility
    const scaleFactor = 2.5;
    const values = rawValues.map(v => Math.min(v * scaleFactor, 1));

    new Chart(document.getElementById("emotionRadar"), {
      type: "radar",
      data: {
        labels: labels,
        datasets: [{
          label: "Weekly Emotion Intensity",
          data: values,
          backgroundColor: "rgba(64,224,208,0.25)",
          borderColor: "#40E0D0",
          borderWidth: 2,
          pointBackgroundColor: "#40E0D0"
        }]
      },
      options: {
        scales: {
          r: {
            min: 0,
            max: 1,
            ticks: {
              display: false // âœ… hides the numeric values like 0.2, 0.4, etc.
            },
            pointLabels: { color: "#E0E0E0" },
            grid: { color: "#333" },
            angleLines: { color: "#444" }
          }
        },
        plugins: { legend: { labels: { color: "#E0E0E0" } } },
        maintainAspectRatio: false
      }
    });
  });


  </script>
</body>
</html>
