<!doctype html>
<html>
<head>
  <title>Equinox Dashboard - {{username}}</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <header>
    <img src="{{ url_for('static', filename='logo.png') }}" alt="Equinox Logo">
    <div>
      <h1>Equinox</h1>
      <p>Balancing minds, one insight at a time.</p>
    </div>
  </header>

  <!-- üåà Aura Section -->
  <section class="aura-card">
    <div class="aura-gradient" id="aura-gradient"></div>
    <div class="aura-text">
      <h2>Your Aura</h2>
      <p id="aura-info">Loading your aura...</p>
    </div>
  </section>

  <!-- üìä Topic Distribution -->
  <section class="chart-card">
    <h2>Topic Distribution</h2>
    <canvas id="topicChart"></canvas>
  </section>

  <!-- üìà Mood Trend -->
  <section class="chart-card">
    <h2>Mood Trend for {{username}}</h2>
    <canvas id="moodChart"></canvas>
  </section>

  <!-- ‚ö†Ô∏è Alerts -->
  <section id="alerts">
    <h3>‚ö†Ô∏è Alerts</h3>
    <div id="alerts-list"></div>
  </section>

  <script>
    // === Fetch Aura ===
    fetch(`/api/aura/{{username}}`)
      .then(r => r.json())
      .then(aura => {
        const auraDiv = document.getElementById("aura-info");
        const gradientDiv = document.getElementById("aura-gradient");

        if (aura.error) {
          auraDiv.textContent = "Not enough data to determine your aura.";
          gradientDiv.classList.add("default-gradient");
          return;
        }

        auraDiv.innerHTML = `<strong>${aura.aura}</strong><br>${aura.description}<br><br><em>${aura.comment}</em>`;

        // Map aura names to gradient classes
        const gradientMap = {
          "Calm Green": "calm-green",
          "Radiant Orange": "radiant-orange",
          "Tranquil Blue": "tranquil-blue",
          "Stormy Gray": "stormy-gray",
          "Blossom Pink": "blossom-pink",
          "Bright Yellow": "bright-yellow"
        };

        const auraName = aura.aura.split(" ").slice(1).join(" "); // remove emoji
        gradientDiv.classList.add(gradientMap[auraName] || "default-gradient");

        // Create topic chart
        const topicData = aura.topics || {};
        const labels = Object.keys(topicData);
        const values = Object.values(topicData);

        if (labels.length > 0) {
          new Chart(document.getElementById("topicChart"), {
            type: "pie",
            data: {
              labels: labels,
              datasets: [{
                data: values,
                backgroundColor: [
                  "#40E0D0", "#FF914D", "#FFB6C1", "#FFD700", "#A0A0A0", "#2bb5a6"
                ]
              }]
            },
            options: {
              plugins: {
                legend: { labels: { color: "#E0E0E0" } }
              }
            }
          });
        }
      });

    // === Fetch posts and mood trend ===
    fetch(`/api/fetch/{{username}}`)
      .then(r => r.json())
      .then(fetchData => {
        if (fetchData.fetched > 0) {
          return fetch(`/api/mood_trend/{{username}}?days=60`);
        } else {
          throw new Error("No posts fetched for this user.");
        }
      })
      .then(r => r.json())
      .then(data => {
        const trend = data.trend || [];
        if (trend.length === 0) {
          alert("No recent posts to plot!");
          return;
        }

        const labels = trend.map(d => d.date);
        const values = trend.map(d => d.avg_compound);

        new Chart(document.getElementById("moodChart"), {
          type: "line",
          data: {
            labels: labels,
            datasets: [{
              label: "Sentiment (compound score)",
              data: values,
              fill: true,
              borderColor: "#40E0D0",
              backgroundColor: "rgba(64,224,208,0.15)",
              tension: 0.25,
              pointRadius: 4,
              pointBackgroundColor: "#40E0D0"
            }]
          },
          options: {
            scales: { 
              y: { min: -1, max: 1, ticks: { color: "#E0E0E0" } },
              x: { ticks: { color: "#E0E0E0" } }
            },
            plugins: { legend: { labels: { color: "#E0E0E0" } } }
          }
        });

        const alerts = data.alerts || [];
        if (alerts.length > 0) {
          const alertBox = document.getElementById("alerts");
          const list = document.getElementById("alerts-list");
          list.innerHTML = "";
          alerts.forEach(a => {
            const div = document.createElement("div");
            div.className = "alert-item";
            div.textContent = `${a.date}: ${a.message}`;
            list.appendChild(div);
          });
          alertBox.style.display = "block";
        }
      });
  </script>
</body>
</html>
