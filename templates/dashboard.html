<!doctype html>
<html>
<head>
  <title>Equinox Dashboard - {{username}}</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: #121212;
      color: #E0E0E0;
      margin: 20px;
    }
    header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 25px;
    }
    header img {
      width: 60px;
      height: 60px;
    }
    header h1 {
      margin: 0;
      font-size: 28px;
      color: #40E0D0;
    }
    header p {
      margin: 0;
      font-size: 14px;
      color: #A0A0A0;
    }

    /* ===== Cards ===== */
    .chart-card {
      background: #1E1E1E;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 25px;
      box-shadow: 0 0 15px rgba(64, 224, 208, 0.2);
    }
    canvas {
      background: #121212;
      border-radius: 8px;
      padding: 10px;
    }

    /* ===== Aura Card ===== */
    .aura-card {
      background: radial-gradient(circle at top left, #40e0d0, #1e1e1e);
      border-radius: 15px;
      padding: 25px;
      text-align: center;
      margin-bottom: 30px;
      box-shadow: 0 0 20px rgba(64, 224, 208, 0.3);
    }
    .aura-card h2 {
      color: #40E0D0;
    }
    .aura-card p {
      color: #E0E0E0;
    }

    /* Forecast message */
    #forecast-message {
      margin-top: 15px;
      text-align: center;
      font-size: 16px;
      color: #40E0D0;
    }
  </style>
</head>
<body>
  <header>
    <img src="{{ url_for('static', filename='logo.png') }}" alt="Equinox Logo">
    <div>
      <h1>Equinox</h1>
      <p>Balancing minds, one insight at a time.</p>
    </div>
  </header>

  <!-- ðŸŒˆ Aura -->
  <div class="aura-card">
    <h2>Your Aura</h2>
    <p id="aura-info">Loading...</p>
  </div>

  <!-- ðŸ“ˆ Mood Trend -->
  <div class="chart-card">
    <h2>Mood Trend for {{username}}</h2>
    <canvas id="moodChart" width="800" height="300"></canvas>
  </div>

  <!-- ðŸ”® Forecast below Mood Trend -->
  <div class="chart-card" id="forecast-card" style="display:none;">
    <h2>Next 7 Days Mood Forecast</h2>
    <canvas id="forecastChart" width="800" height="300"></canvas>
    <p id="forecast-message"></p>
  </div>

  <script>
    const username = "{{username}}";

    // --- Fetch Aura ---
    fetch(`/api/aura/${username}`)
      .then(r => r.json())
      .then(data => {
        const auraDiv = document.getElementById("aura-info");
        if (!data || data.error) {
          auraDiv.textContent = "Not enough data to determine aura.";
        } else {
          auraDiv.innerHTML = `<strong>${data.aura}</strong><br>${data.description}`;
        }
      });

    // --- Fetch posts + mood trend ---
    fetch(`/api/fetch/${username}`)
      .then(r => r.json())
      .then(fetchData => {
        if (fetchData.fetched > 0) {
          return fetch(`/api/mood_trend/${username}?days=60`);
        } else {
          throw new Error("No posts fetched for this user.");
        }
      })
      .then(r => r.json())
      .then(data => {
        const trend = data.trend || [];
        if (trend.length === 0) {
          document.body.innerHTML += "<p>No posts found to analyze.</p>";
          return;
        }

        const labels = trend.map(d => d.date);
        const values = trend.map(d => d.avg_compound);

        new Chart(document.getElementById("moodChart"), {
          type: "line",
          data: {
            labels: labels,
            datasets: [{
              label: "Mood Sentiment (Daily Average)",
              data: values,
              fill: true,
              borderColor: "#40E0D0",
              backgroundColor: "rgba(64,224,208,0.15)",
              tension: 0.25,
              pointRadius: 4,
              pointBackgroundColor: "#40E0D0"
            }]
          },
          options: {
            scales: {
              y: { min: -1, max: 1, ticks: { color: "#E0E0E0" } },
              x: { ticks: { color: "#E0E0E0" } }
            },
            plugins: { legend: { labels: { color: "#E0E0E0" } } }
          }
        });
      })
      .catch(err => console.error(err));

    // --- Fetch Forecast (below trend) ---
    fetch(`/api/forecast/${username}`)
      .then(r => r.json())
      .then(data => {
        if (!data.forecast || data.forecast.length === 0) return;

        const labels = data.forecast.map(f => f.date);
        const values = data.forecast.map(f => f.predicted_mood);

        new Chart(document.getElementById("forecastChart"), {
          type: "line",
          data: {
            labels: labels,
            datasets: [{
              label: "Predicted Mood Score (Next 7 Days)",
              data: values,
              borderColor: "#FFD700",
              backgroundColor: "rgba(255,215,0,0.15)",
              fill: true,
              tension: 0.3
            }]
          },
          options: {
            scales: {
              y: { min: -1, max: 1, ticks: { color: "#E0E0E0" } },
              x: { ticks: { color: "#E0E0E0" } }
            },
            plugins: { legend: { labels: { color: "#E0E0E0" } } }
          }
        });

        const card = document.getElementById("forecast-card");
        card.style.display = "block";
        const msg = document.getElementById("forecast-message");
        msg.innerHTML = data.badge
          ? `${data.badge} â€” ${data.message}`
          : `ðŸ’› ${data.message}`;
      })
      .catch(e => console.error("Forecast error", e));
  </script>
</body>
</html>
